import{applyFilters}from"@wordpress/hooks";async function getUniqueValidationData(t,e,r,o){let s="action=validation_ajax_action&nonce="+encodeURIComponent(o)+"&id="+encodeURIComponent(e);Object.keys(t).forEach(e=>{s+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t[e])});try{var i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s});if(i.ok)return(await i.json()).data}catch(e){console.error(e)}}async function fieldValidation(e,t,r,o,i=!1){let a=!1,s=null,l=null,n={},m=(e,t,r={})=>{s||(s=e,l=t,n=r)},c=null;var f=document.querySelectorAll('input[data-unique="true"]');if(0!==f.length){var u,d={};for(u of f){var g=u.name,w=u.value;d[g]=w}c=await getUniqueValidationData(d,e,t,r)}for(let s of i?[o]:Array.from(o.querySelectorAll(".srfm-block-single"))){let t=!1;if(Array.isArray(window.sureforms?.skipValidationCallbacks)&&window.sureforms.skipValidationCallbacks.forEach(e=>{"function"==typeof e&&(t=t||e(s))}),!t){var b=s.closest("form").getAttribute("form-id");if(b===e){let r,o;o=!0===s.classList.contains("srfm-phone-block")?(r=s.querySelector(".srfm-input-phone"))?.nextElementSibling?.value:(r=s.querySelector("input, textarea, select")).value;var p,S,b=r.getAttribute("data-required"),y=r.getAttribute("data-unique");let t=r.getAttribute("name"),n=s.querySelector(".srfm-error-message");if(t=t&&t.replace(/_/g," "),b&&"hidden"!==r.type&&("true"!==b||o?r&&window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!1):(r&&window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!0),n&&(n.textContent=n.getAttribute("data-error-msg")),a=!0,m(r,r.closest(".srfm-block"))),r.addEventListener("input",()=>{window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!1)})),"true"===y&&""!==o&&(c?.some(e=>"not unique"===e[t])?(r&&window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!0),n.style.display="block",n.textContent=n.getAttribute("data-unique-msg"),a=!0,m(r,r.closest(".srfm-block"))):r&&(window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!1),n.style.display="none")),s.classList.contains("srfm-multi-choice-block")||s.classList.contains("srfm-checkbox-block")||s.classList.contains("srfm-gdpr-block")){var k=s.querySelectorAll("input"),y=k[0].getAttribute("data-required");let t=!1,r=null;for(let e=0;e<k.length;e++)if(r||"hidden"===k[e].type||(r=k[e]),k[e].checked){t=!0;break}"true"!==y||t?n&&window?.srfm?.toggleErrorState(s,!1):(n&&(n.textContent=s.querySelector(".srfm-error-message").getAttribute("data-error-msg"),window?.srfm?.toggleErrorState(s,!0)),a=!0,m(r,s)),k.forEach(e=>{e.addEventListener("input",()=>{window?.srfm?.toggleErrorState(s,!1)})})}if(s.classList.contains("srfm-url-block")&&(y=s.querySelector("input"),s.classList.contains("srfm-url-error")&&(window?.srfm?.toggleErrorState(s,!0),a=!0,m(y,s)),y.addEventListener("input",()=>{window?.srfm?.toggleErrorState(s,!1)})),s.classList.contains("srfm-phone-block")&&(y=s.querySelectorAll("input")[1],s.classList.contains("srfm-phone-error")&&(window?.srfm?.toggleErrorState(s,!0),a=!0,m(y,s)),s.querySelectorAll("input").forEach(e=>{e.addEventListener("input",()=>{window?.srfm?.toggleErrorState(s,!1)})})),s.classList.contains("srfm-password-block-wrap")&&(y=s)&&(y=y.querySelector(".srfm-password-confirm-block"))&&(S=y.querySelector(".srfm-input-password-confirm").value,p=y.querySelector(".srfm-error-message"),!S&&p&&"true"===b?(p.textContent=p.getAttribute("data-error-msg"),window?.srfm?.toggleErrorState(y,!0),m(S,y),a=!0):S!==o?(window?.srfm?.toggleErrorState(y,!0),p.textContent=window?.srfm_submit?.messages?.srfm_confirm_password_same,m(S,y),a=!0):window?.srfm?.toggleErrorState(y,!1)),s.classList.contains("srfm-email-block-wrap")){let t=s;if(t){let e=t.querySelector(".srfm-email-confirm-block");t.classList.contains("srfm-valid-email-error")&&(m(r,t),a=!0),e&&(p=e.querySelector(".srfm-input-email-confirm"),S=e.querySelector(".srfm-input-email-confirm").value,y=e.querySelector(".srfm-error-message"),!S&&y&&"true"===b?(y.textContent=y.getAttribute("data-error-msg"),window?.srfm?.toggleErrorState(e,!0),m(p,e),a=!0):S!==o?(window?.srfm?.toggleErrorState(e,!0),y.textContent=window?.srfm_submit?.messages?.srfm_confirm_email_same,m(p,e),a=!0):window?.srfm?.toggleErrorState(e,!1),p.addEventListener("input",()=>{window?.srfm?.toggleErrorState(e,!1)})),t.querySelector(".srfm-input-email").addEventListener("input",()=>{window?.srfm?.toggleErrorState(t,!1)})}}if(s.classList.contains("srfm-upload-block")&&("true"!==(E=(y=s.querySelector(".srfm-input-upload")).getAttribute("data-required"))||y.value?r&&window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!1):("true"===E&&n&&(n.textContent=n.getAttribute("data-error-msg")),r&&window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!0),a=!0,m(y,s)),y.addEventListener("input",()=>{r&&window?.srfm?.toggleErrorState(r.closest(".srfm-block"),!1)})),s.classList.contains("srfm-number-block")){var E=r.getAttribute("min"),y=r.getAttribute("max"),v=r.getAttribute("format-type");if(o){var v="eu-style"===v?parseFloat(o.replace(/\./g,"").replace(",",".")):parseFloat(o.replace(/,/g,""));if(E||y){let e=!1,t="";E&&""!==E&&Number(v)<Number(E)?(e=!0,t=window?.srfm?.srfmSprintfString(window?.srfm_submit?.messages?.srfm_input_min_value,E)):y&&""!==y&&Number(v)>Number(y)&&(e=!0,t=window?.srfm?.srfmSprintfString(window?.srfm_submit?.messages?.srfm_input_max_value,y)),window?.srfm?.toggleErrorState(r.closest(".srfm-block"),e),n&&(n.textContent=e?t:"",e)&&(a=!0,m(r,s))}}}if(s.classList.contains("srfm-rating-block")&&("true"!==(v=s.querySelector(".srfm-input-rating")).getAttribute("data-required")||v.value?window?.srfm?.toggleErrorState(v.closest(".srfm-block"),!1):(window?.srfm?.toggleErrorState(v.closest(".srfm-block"),!0),a=!0,m(s.querySelector(".srfm-icon"),s))),s.classList.contains("srfm-slider-block")){var y=s.getAttribute("data-required"),h=s.querySelector(".srfm-input-slider"),q=s.querySelector(".srfm-text-slider"),_=s.getAttribute("data-default");if("true"===y){let e=!1;(e=(!h||h.dataset.interacted||_&&"false"!==_)&&(!q||q.dataset.interacted||_&&"false"!==_)?e:!0)?(window?.srfm?.toggleErrorState(s,!0),a=!0,m(h,s)):window?.srfm?.toggleErrorState(s,!1)}}if(s.classList.contains("srfm-dropdown-block")){y=s.querySelectorAll(".srfm-input-dropdown-hidden");let l=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;y.forEach(e=>{let t=e.getAttribute("data-required");var r,o,s,i=e.getAttribute("name");"true"!==t||e.value?e.value?(s=e.getAttribute("data-min-selection"),r=e.getAttribute("data-max-selection"),(s||r)&&(o=window.srfm.srfmUtility.extractValue(e.value),s&&o.length<s?(n.textContent=window?.srfm?.srfmSprintfString(window?.srfm_submit?.messages?.srfm_dropdown_min_selections,s),window?.srfm?.toggleErrorState(e.closest(".srfm-block"),!0),a=!0):r&&o.length>r&&(n.textContent=window?.srfm?.srfmSprintfString(window?.srfm_submit?.messages?.srfm_dropdown_max_selections,r),window?.srfm?.toggleErrorState(e.closest(".srfm-block"),!0),a=!0))):window?.srfm?.toggleErrorState(e.closest(".srfm-block"),!1):(n.textContent=n.getAttribute("data-error-msg"),window?.srfm?.toggleErrorState(e.closest(".srfm-block"),!0),a=!0),a&&(s=window?.srfm?.[i]||e,m(s,e.closest(".srfm-block"),{shouldDelayOnFocus:!0})),new l(()=>{e.value?window?.srfm?.toggleErrorState(e.closest(".srfm-block"),!1):"true"===t&&window?.srfm?.toggleErrorState(e.closest(".srfm-block"),!0)}).observe(e,{attributes:!0,attributeFilter:["value"]})})}if(s.classList.contains("srfm-multi-choice-block")){var A=s.querySelectorAll("input"),q=A[0].getAttribute("data-min-selection"),_=A[0].getAttribute("data-max-selection");let t=null,r=0,e=!1;for(let e=0;e<A.length;e++)t||"hidden"===A[e].type||(t=A[e]),A[e].checked&&r++;(q||_)&&0<r&&(!e&&0<q&&(b&&1<q||!b)&&r<q&&(n.textContent=window?.srfm?.srfmSprintfString(window?.srfm_submit?.messages?.srfm_multi_choice_min_selections,q),e=!0),!e&&0<_&&r>_&&(n.textContent=window?.srfm?.srfmSprintfString(window?.srfm_submit?.messages?.srfm_multi_choice_max_selections,_),e=!0),e?(window?.srfm?.toggleErrorState(s,!0),m(t,s),a=!0):b||window?.srfm?.toggleErrorState(s,!1))}a=applyFilters("srfm.modifyFieldValidationResult",a,s,m)}}}return!!a&&{validateResult:a,firstErrorInput:s,scrollElement:l,...n}}function initializeInlineFieldValidation(){["srfm-input-block","srfm-email-block-wrap","srfm-url-block","srfm-phone-block","srfm-checkbox-block","srfm-gdpr-block","srfm-number-block","srfm-multi-choice-block","srfm-datepicker-block","srfm-upload-block","srfm-rating-block","srfm-textarea-block","srfm-dropdown-block","srfm-slider-block"].forEach(e=>addBlurListener(e,"."+e)),validateMultiChoiceMinMax()}function validateMultiChoiceMinMax(){document.querySelectorAll(".srfm-multi-choice-block").forEach(e=>{let n=e.querySelector(".srfm-input-multi-choice-hidden");if(n){let i=n.getAttribute("data-min-selection"),l=n.getAttribute("data-max-selection");if(i||l){let o=e.querySelector(".srfm-error-message"),s=window?.srfm_submit?.messages||{};e.addEventListener("input",()=>{var t=window.srfm.srfmUtility.extractValue(n.value).filter(Boolean).length;if(0===t)window?.srfm?.toggleErrorState(e,!1);else{var r=n.closest(".srfm-block");let e="";i&&t<i?e=window?.srfm?.srfmSprintfString(s.srfm_multi_choice_min_selections,i):l&&t>l&&(e=window?.srfm?.srfmSprintfString(s.srfm_multi_choice_max_selections,l)),o.textContent=e,window?.srfm?.toggleErrorState(r,Boolean(e))}})}}})}function addBlurListener(e,r){var t=Array.from(document.getElementsByClassName(e));if(t)for(var o of t){let t=o.querySelector("input")||o.querySelector("textarea")||o.querySelector("select");if("srfm-upload-block"===e&&(t=o.querySelector('input[type="file"]')),"srfm-rating-block"===e&&addRatingBlurListener(t,o,r),"srfm-multi-choice-block"===e&&addMultiChoiceBlurListener(t,o,r),"srfm-email-block-wrap"===e&&addEmailBlurListener(o,r),"srfm-slider-block"===e&&addSliderBlurListener(t,o,r),"srfm-dropdown-block"===e){let e=t.getAttribute("name");setTimeout(()=>{window?.srfm?.[e]?.on("blur",function(){fieldValidationInit(t,r)})},500)}(t="srfm-phone-block"===e?o.querySelector(".srfm-input-phone"):t)&&t.addEventListener("blur",async function(){fieldValidationInit(t,r)})}}function addRatingBlurListener(e,t,r){t.querySelectorAll(".srfm-icon").forEach(e=>{e.addEventListener("blur",async function(){fieldValidationInit(e,r)})})}function addMultiChoiceBlurListener(e,t,r){t.querySelectorAll(".srfm-input-multi-choice-single").forEach(e=>{e.addEventListener("blur",async function(){fieldValidationInit(e,r)})})}function addEmailBlurListener(e,t){var r=e.querySelectorAll("input");let l=e.closest(t);r.forEach(i=>{i.addEventListener("input",async function(){i.value=i.value.trim().toLowerCase();let e=!1;/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(i.value)&&(e=!0);var t=i.classList.contains("srfm-input-email-confirm")?l.querySelector(".srfm-email-confirm-block"):l.querySelector(".srfm-email-block"),r=t.querySelector(".srfm-error-message");if(i.value||(r.style.display="none",t.classList.remove("srfm-valid-email-error")),i.classList.contains("srfm-input-email-confirm")){var o=l.querySelector(".srfm-input-email"),s=l.querySelector(".srfm-email-confirm-block").querySelector(".srfm-error-message");if(o.value!==i.value)return s.style.display="block",s.textContent=window?.srfm_submit?.messages?.srfm_confirm_email_same,void window?.srfm?.toggleErrorState(l,!0);window?.srfm?.toggleErrorState(l,!1),s.textContent="",s.style.display="none"}""===i?.value||e?(r.style.display="none",t.parentElement.classList.remove("srfm-valid-email-error"),r.removeAttribute("id")):(t.parentElement.classList.add("srfm-valid-email-error"),r.style.display="block",r.innerHTML=window?.srfm_submit?.messages?.srfm_valid_email,r.id=r.getAttribute("data-srfm-id"))})})}function addSliderBlurListener(e,t,r){let o=t.querySelector(".srfm-input-slider");t=t.querySelector(".srfm-text-slider");if(o&&o.addEventListener("blur",async function(){fieldValidationInit(o,r)}),t){let e=t.querySelector(".srfm-slider-thumb");e&&e.addEventListener("blur",async function(){fieldValidationInit(e,r)})}}let fieldValidationInit=async(e,t)=>{e=e.closest(t),t=e.closest("form");await fieldValidation(t.getAttribute("form-id"),t.getAttribute("ajaxurl"),t.getAttribute("data-nonce"),e,!0)},handleScrollAndFocusOnError=e=>{var t,r;e?.firstErrorInput&&(e?.scrollElement&&(t=e.scrollElement.getBoundingClientRect().top,r=window.pageYOffset,window.scroll({top:t+r-window.innerHeight/2,behavior:"smooth"})),e?.shouldDelayOnFocus?setTimeout(()=>{e.firstErrorInput.focus({preventScroll:!0})},500):e.firstErrorInput.focus({preventScroll:!0}))},handleCaptchaValidation=(e,t,r,o)=>{if(!(e||t||r||o))return!0;let s;"v2-checkbox"===e?s=grecaptcha.getResponse():t?s=hcaptcha.getResponse():r&&(s=turnstile.getResponse());e=0<s.length;return o.style.display=e?"none":"block",e};export{fieldValidation,initializeInlineFieldValidation,handleScrollAndFocusOnError,handleCaptchaValidation};